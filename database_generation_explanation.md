# How `generated_objs_0.db` was Generated in SynFlowNet

## Overview

The file `/home/ubuntu/synflownet/logs/debug_run_reactions_task_2025-06-17_20-05-58/final/generated_objs_0.db` is a SQLite database that was created during the final molecule generation phase of a SynFlowNet training run. This database contains logged information about molecules sampled during the final evaluation phase.

## Generation Process

### 1. SQLiteLogHook Class

The database is created by the `SQLiteLogHook` class defined in `src/synflownet/utils/sqlite_log.py`. This hook is responsible for:

- Creating SQLite database files to log molecule generation results
- Setting up database tables with appropriate schema
- Inserting sampled molecule data during the generation process

**Key code from `sqlite_log.py`:**

```python
class SQLiteLogHook:
    def __init__(self, log_dir, file_prefix="generated_objs"):
        self.log_dir = log_dir
        self.file_prefix = file_prefix
        self.worker_id = get_worker_info().id if get_worker_info() is not None else 0
        self.db_file = os.path.join(log_dir, f"{file_prefix}_{self.worker_id}.db")
        self.sqlitelog = SQLiteLog(self.db_file)
```

### 2. Database Table Schema

Based on the actual generated database, the `results` table contains the following columns:

- **smi** (TEXT): SMILES string representation of the generated molecule
- **r** (REAL): Final reward/score for the molecule (ranging from 0 to 1)
- **traj** (TEXT): String representation of the generation trajectory showing the step-by-step synthesis path
- **fr_0** (REAL): Objective property value (appears to be the same as reward in this case)
- **ci_beta** (REAL): Conditioning information parameter (set to 32.0 for all samples)

**Example data from the actual database:**
- **Row count**: 6,400 generated molecules
- **Sample molecule**: `'Cc1ccc(CC#N)c(C(=O)N2CCC(S(C)(=O)=O)CC2)c1'` with reward `0.849`
- **Sample trajectory**: Shows synthesis steps from empty molecule to final product via reactant additions

### 3. Integration with Trainer

The hook is attached to data loaders during the final evaluation phase in the `GFNTrainer` class (`src/synflownet/trainer.py`):

**Key code from `trainer.py`:**

```python
def build_final_data_loader(self, model):
    # Creates data source for final molecule generation
    data_source = self.build_data_source(model, replay_buffer=None)
    
    # Attaches SQLiteLogHook to log results
    final_log_dir = os.path.join(self.config.log_dir, "final")
    os.makedirs(final_log_dir, exist_ok=True)
    data_source.add_log_hook(SQLiteLogHook(final_log_dir))
    
    return self.build_data_loader(data_source, is_algo=False)
```

### 4. File Naming Convention

The database file follows this naming pattern:
- **Directory**: `{log_dir}/final/` where `log_dir` is the main logging directory for the run
- **Filename**: `generated_objs_{worker_id}.db` where `worker_id` is the DataLoader worker ID (0 for single-worker)

For the specific file `generated_objs_0.db`:
- `0` indicates this was generated by worker 0 (likely a single-worker setup)
- Located in the `final` subdirectory indicating this was from the final evaluation phase

### 5. Data Logging Process

During molecule generation, the `SQLiteLogHook` processes each batch of generated molecules:

1. **Molecule Conversion**: Each generated molecule is converted to SMILES format using `ctx.object_to_log_repr()`
2. **Trajectory Logging**: The synthesis trajectory is converted to string format using `ctx.traj_to_log_repr()`
3. **Data Collection**: For each molecule, the following data is collected:
   - SMILES string (`smi`)
   - Final reward score (`r`)
   - Generation trajectory (`traj`)
   - Objective properties (`fr_0`)
   - Conditioning information (`ci_beta`)

**Key insertion code from the actual hook:**

```python
def __call__(self, trajs, rewards, obj_props, cond_info):
    # Convert trajectories to SMILES and trajectory strings
    objs = [self.ctx.object_to_log_repr(t["result"]) for t in trajs]
    trajs = [self.ctx.traj_to_log_repr(t["traj"]) for t in trajs]
    
    # Prepare data for insertion
    data = [
        [objs[i], rewards[i], trajs[i]]
        + obj_props[i]
        + [cond_info[k][i].item() for k in logged_keys]
        for i in range(len(trajs))
    ]
    
    # Insert into database
    self.log.insert_many(data, self.data_labels)
```

**Actual trajectory example from the database:**
```
[('', <GraphActionType.AddFirstReactant, 426>), 
 ('Cc1ccc(CC#N)c(C(=O)O)c1', <GraphActionType.ReactBi, 72, 3824>), 
 ('Cc1ccc(CC#N)c(C(=O)N2CCC(S(C)(=O)=O)CC2)c1', <GraphActionType.ReactBi, 34, 2381>), 
 ('Cc1ccc(CC#N)c(C(=O)N2CCC(S(C)(=O)=O)CC2)c1', <GraphActionType.Stop, 0, 0>)]
```

This shows the step-by-step synthesis: starting empty → adding first reactant → two bimolecular reactions → stopping.

## Summary

The `generated_objs_0.db` file was automatically created during a SynFlowNet training run on June 17, 2025, specifically during the final molecule generation phase. It contains a comprehensive log of **6,400 molecules** sampled by the trained model, including:

- **Chemical structures** as SMILES strings (e.g., complex drug-like molecules with multiple functional groups)
- **Reward scores** ranging from ~0.85 to ~0.93, indicating high-quality molecules
- **Synthesis trajectories** showing the step-by-step generation process via reaction templates
- **Objective properties** and **conditioning parameters** used during generation

The database demonstrates successful molecule generation using a reaction-based approach, where molecules are built incrementally through chemical reactions rather than atom-by-atom assembly. Each trajectory shows the specific reactants and reaction templates used, making the synthesis paths chemically interpretable and potentially executable in a laboratory setting.

## Supporting Files

- **Main logging implementation**: `src/synflownet/utils/sqlite_log.py`
- **Hook integration**: `src/synflownet/trainer.py` (build_final_data_loader method)
- **Data source**: `src/synflownet/data/data_source.py`
- **Task configuration**: `src/synflownet/tasks/reactions_task.py`
